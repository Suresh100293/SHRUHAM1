@model ALT_ERP3.AdvancePayModel
@using Common

<div class="modal-body">
    <div class="modal-content">
        <div class="modal-header" style="background-color:#cccccc;padding-top:5px;">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title"><b></b></h4>
        </div>
        <div class="modal-body" style="min-height:300px;">
            <div class="form-group">
                <label class="col-sm-1 control-label">Account:</label>
                <div class="col-sm-3">
                    @Html.TextBoxFor(m => m.Code, new
               {
                   @style = "width:99%; margin-top:2px;height:25px;",
                   @class = "input-large search-query",
                   @Name = "txtAccount",
                   @Id = "txtAccount"
               })

                </div>
                @Html.TextBoxFor(x => x.tempid, new { @class = "form-control", @id = "addtempId", @Name = "addtempId", @style = "text-align:right;display:none;" })
                @*<label class="col-sm-1 control-label">Amount:</label>
                <div class="col-sm-2 control-label" style="padding-top:0px;">
                    @Html.TextBoxFor(x => x.Amt, new { @class = "form-control", @id = "addAmt", @Name = "addAmt", @style = "text-align:right;" })
                </div>*@
            </div>

            <div style="max-height:300px;min-height:300px;overflow-y:scroll;width:100%; ">

                <div id="LRDetailsDialog" class="hidden" style="display:block;">
                    @Html.Partial("LRDetails")
                </div>
                <br /> 
            </div>

            <div class="footer-section" style="position:relative;background-color:white;padding:2px;color:unset;width:85%">
                <label class="col-sm-1 control-label">Remark:</label>
                @Html.TextAreaFor(x => x.Narr, new { @id = "txtNarr", @name = "txtNarr", @Value = @Model.Narr, @cols = 140, @rows = 2 })
            </div>
        </div>
        <div class="modal-footer" style="background-color:#cccccc;height:42px;padding-bottom:5px;padding-top:5px;border-radius: 0px 0px 5px 5px;">
            <button class="btn btn-warning" id="btnAddDoc" style="font-size: 13px;padding:3px 12px;" name="Command">Attach Doc</button>
            <button type="button" class="btn btn-success" id="btnadddetSave">Save</button>
            <button data-dismiss="modal" class="btn btn-danger" type="button">Close</button>
        </div>
    </div>
</div>

@*<div class="example-modal">
    <div id="attachdoc" class="modal modal-primary">
        <div class="modal-dialog" style="width:700px;">
            <div id="AttachDoc">
                @Html.Partial("AttachmentDocument")
            </div>
        </div>
    </div>
</div>*@


<script>
    $(document).ready(function () {


		$("#addAmt").constrain({ allow: { regex: "[0-9.]" } });


        loadaccount1();

		 if ('@Model.PartialDivName' == "LR"  ) {
            $('#LRDetailsDialog').removeClass("hidden");
        }
        else {
            debugger;
            
            $('#LRDetailsDialog').addClass("hidden");
           
        }
        $("#txtAccount").change(function (event) {
            event.preventDefault();
            var ModelData = {};
            ModelData["Code"] = $("#txtAccount").val();
            ModelData["AmtType"] = $("input[name=AmtType]:checked").val();
            var AccReqRelated = $("#Yes").prop('checked');

            var DTO = { Model: ModelData };
            var url = '@Url.Action("RelatedToDecide")';
            $.ajax({
                type: "POST",
                dataType: "json",
                data: JSON.stringify(DTO),
                cache: false,
                url: url,
                contentType: "application/json;charset=utf-8",
                beforeSend: function () {
                    $('.spinner').show();
                },
                success: function (data) {
                    $('.spinner').hide();

                    $("#hdnPartialDivName").val(data.PartialDivName);

                     if (data.PartialDivName == "3") {

                        $('#LRDetailsDialog').removeClass("hidden");
                        
                    }
                    else {
                        $('#LRDetailsDialog').addClass("hidden");
                    }

                },
                error: function () {
                    alert("Error occured while processing your request.");
                }
            });

        });
        $('#btnadddetSave').click(function (event) {
            event.preventDefault();

            $("#btnadddetSave").prop("disabled", true);
            var RequiredDataValidation = $("#Yes").prop('checked');
            var ModelData = {};
            var Flg = true;
            var rlarray = [];
           
            debugger;
            var ModelData = {};

            //LR Details Save
            var myBatchArray = [];
            $('#lrtabledata tbody tr').each(function () {
                var tds = $(this).find('td');
                var myDets = {
                    tempid: tds.eq(1).text(),
                    LRNumber: tds.eq(2).text(),
                    LRAmt: tds.eq(3).text(),
                    ConsignmentKey: tds.eq(5).text(),
                }
                myBatchArray.push(myDets);
            })
            ModelData["LRDetailList"] = myBatchArray;
            ModelData["SessionFlag"] = '@Model.SessionFlag';
            ModelData["SubType"] = $("#hdnSubType").val();
            ModelData["MainType"] = $("#hdnMainType").val();
            ModelData["Type"] = $("#hdnType").val();
            ModelData["AmtType"] = $("input[name=AmtType]:checked").val();
            ModelData["Code"] = $("#txtAccount").val();
            ModelData["BankCashCode"] = $("#BankCashCode").val()
            ModelData["Amt"] = $("#addAmt").val();
            ModelData["AccountName"] = $("#txtAccount").select2('data').text;
            ModelData["tempId"] = $('#hdntempId').val();
            ModelData["RelatedTo"] = $('#RelatedTo').val();
            ModelData["RelatedChoice"] = $('#RelatedChoice').val();
            ModelData["Narr"] = $('#txtNarr').val();
            ModelData["PartialDivName"] = $('#hdnPartialDivName').val();
            ModelData["NoDuplExpDt"] = $('#hdnNoDuplExpDt').val();
            ModelData["DuplExpDtConfirm"] = $('#hdnDuplExpDtConfirm').val();
            ModelData["ParentKey"] = $("#hdnParentKey").val();
            ModelData["BTNNO"] = $("#hdnBTNNO").val();
            ModelData["BTNNOCombo"] = $("#hdnBTNNOCombo").val();
            ModelData["BTNTotalAmt"] = $("#hdnBTNTotalAmt").val();
            ModelData["BTNBalAmt"] = $("#hdnBTNBalAmt").val();
            ModelData["AccReqRelated"] = $("#hdnAccReqRelated").val();
            ModelData["SetupReqRelatedAc"] = $("#hdnSetupReqRelatedAc").val();

            var DTO = { Model: ModelData };
            var url = '@Url.Action("ConfirmRelationAddEdit")';
            $.ajax({
                type: "POST",
                dataType: "json",
                data: JSON.stringify(DTO),
                cache: false,
                url: url,
                contentType: "application/json;charset=utf-8",
                beforeSend: function () {
                    $('.spinner').show();
                },
                success: function (data) {
                    $('.spinner').hide();
                    debugger;
                    if (data.Status == "ConfirmError") {
                        var confrm = confirm(data.Message);
                        if (confrm == false) {
                            $("#btnadddetSave").prop("disabled", false);
                            return;
                        } else {
                            AddEditDetails()
                        }
                    }
                    else if (data.Status == "ConfirmError1") {
                        alert(data.Message);
                    }else {
                        AddEditDetails()
                    }

                },
                error: function () {
                    alert("Error occured while processing your request.");
                }
            });

        })


        $("#addAmt").focusout(function (event) {

            if ($('#RelatedTo').val() == "000008" || $('#RelatedTo').val() == "000010" || $('#RelatedTo').val() == "000013") {
                $('#truckrelatedtable tbody tr').each(function () {
                    var tds = $(this).find('td');
                    if (tds.eq(0).text() == "F002") {
                        tds.find(".addontxtfvalue").val($('#addAmt').val())
                    }
                })
            }
            else if ($('#RelatedTo').val() == "000014" || $('#RelatedTo').val() == "000011") {
                $('#truckrelatedtable tbody tr').each(function () {
                    var tds = $(this).find('td');
                    if (tds.eq(0).text() == "F001") {
                        tds.find(".addontxtfvalue").val($('#addAmt').val())
                    }
                })
            }
            else if ($('#RelatedTo').val() == "000003") {
                $('#truckrelatedtable tbody tr').each(function () {
                    var tds = $(this).find('td');
                    if (tds.eq(0).text() == "F004") {
                        tds.find(".addontxtfvalue").val($('#addAmt').val())
                    }
                })
            }
            else if ($('#RelatedTo').val() == "000001") {
                $('#truckrelatedtable tbody tr').each(function () {
                    var tds = $(this).find('td');
                    if (tds.eq(0).text() == "F008") {
                        tds.find(".addontxtfvalue").val($('#addAmt').val())
                    }
                })
            }

        })

         $("#btnAddDoc").click(function (event) {
            event.preventDefault();
            var url = '@Url.Action("UploadFile")';
            $.ajax({
                async: false,
                cache: false,
                url: url,
                type: "POST",
                dataType: "json",
                cache: false,
                contentType: "application/json; charset=utf-8",
                beforeSend: function () {
                    $('.spinner').show();
                },
                success: function (data) {
                    $('.spinner').hide();
                    $('#attachdoc').modal('show');
                    $('#controllername').val(data.Controller);
                },
            });
        });



    });
     function loadaccount1() {

        var url = '@Url.Action("GetAccountListExp")';
         $('#txtAccount').select2({
            minimumInputLength: 0,
            placeholder: 'Search',
            ajax: {
                url: url,
                dataType: 'json',
                quietMillis: 100,
                enableFiltering: true,
                allowClear: true,
                minimumInputLength: 0,
                multiple: true,
                width: 300,
                data: function (term, page) {
                    return {
                        types: ["exercise"],
                        limit: -1,
                        term: term
                    };
                },
                results: function (data, page) {
                    clientObj = JSON.stringify(data);
                    return {
                        results: $.map(data, function (item) {
                            return {
                                text: item.Name,
                                id: item.Code
                            }
                        })
                    };
                }
            },
            initSelection: function (element, callback) {
                var data = { id: '@Model.Code', text:'@Model.AccountName' };
                callback(data);
            },
            formatResult: function (exercise) {
                return "<div class='row-fluid'><div class=''><span class='span1'><div style='color:" + exercise.alias + "'>" + exercise.text +
                    "</div></span></div></div>";
            },
            formatSelection: function (exercise) {
                return "<div class='row-fluid'><div class=''><span class='span1'><div style='color:" + exercise.alias + "'>" + exercise.text +
                    "</div></span></div></div>";
            },
         })
    };


    function AddEditDetails() {
        debugger;
        var RequiredDataValidation = $("#Yes").prop('checked');
            var myBatchArray = [];
            $('#lrtabledata tbody tr').each(function () {
                var tds = $(this).find('td');
                var myDets = {
                    tempid: tds.eq(1).text(),
                    LRNumber: tds.eq(2).text(),
                    LRAmt: tds.eq(3).text(),
                    ConsignmentKey: tds.eq(5).text(),
                }
                myBatchArray.push(myDets);
            })
           

            var ModelData = {};
        ModelData["SessionFlag"] = '@Model.SessionFlag';
            ModelData["SubType"] = $("#hdnSubType").val();
            ModelData["MainType"] = $("#hdnMainType").val();
            ModelData["Type"] = $("#hdnType").val();
            ModelData["AmtType"] = $("input[name=AmtType]:checked").val();
            ModelData["Code"] = $("#txtAccount").val();
			ModelData["BankCashCode"] = $("#BankCashCode").val()
            ModelData["Amt"] = $("#addAmt").val();
            ModelData["AccountName"] = $("#txtAccount").select2('data').text;
            ModelData["LRDetailList"] = myBatchArray;
            ModelData["tempId"] = $('#hdntempId').val();
            ModelData["RelatedTo"] = $('#RelatedTo').val();
            ModelData["RelatedChoice"] = $('#RelatedChoice').val();
            ModelData["Narr"] = $('#txtNarr').val();
            ModelData["PartialDivName"] = $('#hdnPartialDivName').val();
            ModelData["NoDuplExpDt"] = $('#hdnNoDuplExpDt').val();
        ModelData["DuplExpDtConfirm"] = $('#hdnDuplExpDtConfirm').val();
        ModelData["ParentKey"] = $("#hdnParentKey").val();
        ModelData["BTNNO"] = $("#hdnBTNNO").val();
        ModelData["BTNNOCombo"] = $("#hdnBTNNOCombo").val();
        ModelData["BTNTotalAmt"] = $("#hdnBTNTotalAmt").val();
        ModelData["BTNBalAmt"] = $("#hdnBTNBalAmt").val();
			ModelData["AccReqRelated"] = $("#hdnAccReqRelated").val();
        ModelData["SetupReqRelatedAc"] = $("#hdnSetupReqRelatedAc").val();
            var DTO = { Model: ModelData };
            var url = '@Url.Action("AddCashLedger")';
            $.ajax({
                type: "POST",
                dataType: "json",
                data: JSON.stringify(DTO),
                cache: false,
                url: url,
                contentType: "application/json;charset=utf-8",
                beforeSend: function () {
                    $('.spinner').show();
                },
                success: function (data) {
                    debugger;
                    $('.spinner').hide();
                    if (data.Status == "ValidError") {
                        alert(data.Message)
                        $("#btnadddetSave").prop("disabled", false);
                        return;
                    }
                    else {
                        $('#divLedgerTable4').html(data.Html);
                        $('#SumDebit').val(data.Sumdebit.toFixed(2));
                        $('#SumCredit').val(data.Sumcredit.toFixed(2));
                    }

                },
                error: function () {
                    alert("Error occured while processing your request.");
                }
            });
    }
</script>


@Html.HiddenFor(x => x.SessionFlag, new { @id = "hdnSessionFlag", @name = "hdnSessionFlag" })
@Html.HiddenFor(x => x.PartialDivName, new { @id = "hdnPartialDivName", @name = "hdnPartialDivName" })
@Html.HiddenFor(x => x.tempid, new { @id = "hdntempId", @name = "hdntempId" })
@Html.HiddenFor(x => x.TableKey, new { @id = "hdnAccTableKey", @name = "hdnAccTableKey" })

