@model AdvancePayModel
@using Common;

<div class="modal-body">
    <div class="modal-content">
        <div class="modal-header" style="background-color:#cccccc;padding-top:5px;">
            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
            <h4 class="modal-title"><b>Ledger Posting</b></h4>
        </div>
        <div class="modal-body">
            <div class="grid" id="LedgerPostTable" style="max-height:360px;min-height:360px; width:100%; overflow: scroll;">
                <table id="LedgerPostgrid" class="zui-table">
                    <thead>
                        <tr role="row" style="font-family:Tahoma;font-size:9pt;">
                            <th style="width:3%">Sr.</th>
                            <th style="width:15%">Code</th>
                            <th style="width:35%">Account Descr</th>
                            <th style="width:15%">Debit</th>
                            <th style="width:15%">Credit</th>
                            <th style="width:10%">Branch</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.LedgerPostList != null)
                        {
                            foreach (var item in @Model.LedgerPostList.ToList())
                            {
                            <tr id="datacharge" style="font-family:Tahoma;font-size:9pt;border:solid 1px lightgray;">
                                <td style="width:3%;">@item.tempid</td>
                                <td style="width:15%;">@item.Code</td>
                                <td style="width:35%;">@item.AccountName</td>
                                <td style="width:15%;text-align:right">@GetAbsolute(@item.Debit)</td>
                                <td style="width:15%;text-align:right">@GetAbsolute(@item.Credit)</td>
                                <td style="width:10%;">@item.Branch</td>
                                <td style="width:10%;" hidden>@item.PostCode</td>
                            
                              
                            </tr>
                            }
                        }
                    </tbody>
                    <tfoot>
                        <tr style="font-family:Tahoma;font-size:9pt;font-weight:bolder;border: solid 1px lightgray;background-color:lightgray;">
                            <td style="width:3%;"></td>
                            <td style="width:15%;"></td>
                            <td style="width:35%;">Total</td>
                            <td style="width:15%;text-align:right" id="txtledpostdeb"></td>
                            <td style="width:15%;text-align:right" id="txtledpostcred"></td>
                            <td style="width:10%;"></td>
                        </tr>
                    </tfoot>
                </table>

            </div>
        </div>
        <div class="modal-footer" style="background-color:#cccccc;height:42px;padding-bottom:5px;padding-top:5px;border-radius: 0px 0px 5px 5px;">
            <button type="button" class="btn btn-warning" data-dismiss="modal" id="SaveLedgerPost">Save</button>
            <button data-dismiss="modal" class="btn btn-danger" type="button" id="CancelPosting" >Cancel</button>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {
        document.getElementById('txtledpostdeb').innerHTML = parseFloat(@Model.TotDebit).toFixed(2);
        document.getElementById('txtledpostcred').innerHTML = parseFloat(@Model.TotCredit).toFixed(2);
        var tdeb = 0;
        var tcred = 0;

        $('#CancelPosting').click(function (event) {
            event.preventDefault();
            $("#Print").prop("disabled", false);
            $("#btnSave").prop("disabled", false);
        });
        $('#SaveLedgerPost').click(function (event) {
            event.preventDefault();
            $("#SaveLedgerPost").prop("disabled", true);
            $('#LedgerPostgrid tfoot').find('tr').each(function () {
                var $tds = $(this).find('td');
                tdeb += parseFloat($tds.eq(3).text());
                tcred += parseFloat($tds.eq(4).text());

            });
            if (tdeb != tcred)
            {
                alert('Credit and Debit doesnt Match cant Save')
                $("#SaveLedgerPost").prop("disabled", false);
                return;
            }
            else
            {
               var myLederArray = [];
               $('#LedgerPostgrid tbody').find('tr').each(function () {
                   var tds = $(this).find('td');

                   var myDets = {
                       tempId: tds.eq(0).text(),
                       Code: tds.eq(1).text(),
                       Debit: tds.eq(3).text(),
                       Credit: tds.eq(4).text(),
                       PostCode: tds.eq(6).text(),
                   }
                   myLederArray.push(myDets);
               });
               var url = '@Url.Action("SaveData")';
               var ModelData = {};
               var myBatchArray = [];
               $('#lrtabledata tbody tr').each(function () {
                   var tds = $(this).find('td');
                   var myDets = {
                       tempId: tds.eq(1).text(),
                       LRNumber: tds.eq(2).text(),
                       LRAmt: tds.eq(3).text(),
                   }
                   myBatchArray.push(myDets);
               });
               ModelData["LRDetailList"] = myBatchArray;
               ModelData["DocuDate"] = $("#DocuDate").val();
               ModelData["Account"] = $("#Account").val();
               ModelData["Bank"] = $("#Bank").val();
               ModelData["MainType"] = $("#hdnMainType").val();
               ModelData["SubType"] = $("#hdnSubType").val();
               ModelData["Type"] = $("#hdnType").val();
               ModelData["Prefix"] = $("#hdnPrefix").val();
               ModelData["ParentKey"] = $("#hdnParentKey").val();
               ModelData["Amt"] = $("#Amt").val();
               ModelData["NetAmt"] = $("#NetAmt").val();
               ModelData["Srl"] = $("#Srl").val();
               ModelData["Mode"] = $("#hdnMode").val();
               /*ModelData["AddOnList"] = AddonSerial;*/
               ModelData["Header"] = '@Model.Header';
               ModelData["Remark"] = $("#Remark").val();
               ModelData["ChequeNo"] = $("#ChequeNo").val();
               ModelData["AdvType"] = $("#AdvType").val();
               ModelData["Controller2"] = '@Model.Controller2';
               ModelData["Module"] = '@Model.Module';
               ModelData["ViewDataId"] = '@Model.ViewDataId';
               ModelData["TableName"] = '@Model.TableName';
               ModelData["OptionType"] = '@Model.OptionType';
               ModelData["OptionCode"] = '@Model.OptionCode';
               ModelData["LedgerPostList"] = myLederArray;
               ModelData["LedgerSrl"] = $("#hdnLedgerSrl").val();
               ModelData["LedgerPrefix"] = $("#hdnLedgerPrefix").val();
               ModelData["LedgerParentKey"] = $("#hdnLedgerParentKey").val();
               ModelData["LedgerType"] = $("#hdnLedgerType").val();
               ModelData["LedgerSubType"] = $("#hdnLedgerSubType").val();
               ModelData["Branch"] = $('#hdnBranch').val();
               ModelData["AccAmt"] = $("#UpAccAmt").val();
                ModelData["Amt"] = $("#txtinvamt").val();
               if ($('#addGSTNoItc').is(":checked"))
               {
                   ModelData["GSTFlag"] = $("#addGSTNoItc").prop('checked');
                   ModelData["GSTCode"] = $("#addGSTCode").val();

                   ModelData["IGSTRate"] = $("#addIGSTRate").val();
                   ModelData["CGSTRate"] = $("#addCGSTRate").val();
                   ModelData["SGSTRate"] = $("#addSGSTRate").val();

                   ModelData["IGSTAmt"] = $("#txttotigst").val();
                   ModelData["CGSTAmt"] = $("#txttotsgst").val();
                   ModelData["SGSTAmt"] = $("#txttotcgst").val();
               }
               if ($('#addTDSFlag').is(":checked"))
               {
                   ModelData["TDSFlag"] = $("#addTDSFlag").prop('checked');
                   ModelData["TDSCode"] = $("#addTDSCode").val();
                   ModelData["TDSRate"] = $("#addTDSRate").val();
                   ModelData["TDSAmt"] = $("#TDSAmt").val();
               }
               var DTO = { Model: ModelData };
               $.ajax({
                   type: "POST",
                   dataType: "json",
                   data: JSON.stringify(DTO),
                   cache: false,
                   url: url,
                   contentType: "application/json; charset=utf-8",
                   beforeSend: function () {
                       $('.spinner').show();
                   },
                   success: function (data)
                   {
                       if (data.Status == 'Success')
                       {
                           alert("Document Saved as " + data.NewSrl + "");
                           if (PrintLR == "SavePrint")
                           {
                               $('#hdnDocument').val(data.NewSrl);
                               $('.spinner').hide();
                               $('#printpostmodel').modal('show');
                           }
                           else
                           {
                               if ($('#hdnMode').val() != "Add") {
                                   window.location.href = "/Accounts/MasterGrid?Type=@Model.Type&Module=@Model.Module&ViewDataId=@Model.ViewDataId&TableName=@Model.TableName&Header=@Model.Header&OptionCode=@Model.OptionCode&MainType=@Model.MainType&SubType=@Model.SubType&Controller2=@Model.Controller2";
                               }
                               else
                               {
                                   window.location.href = "/Accounts/" + '@Model.Controller2' + "/Index?Type=" + '@Model.Type' + '&ChangeLog=Add&Mode=Add' + '&ViewDataId=' + '@Model.ViewDataId' + '&Header=' + '@Model.Header' + '&Module=' + '@Model.Module' + '&TableName=' + '@Model.TableName'  + '&OptionCode=' + '@Model.OptionCode' + '&Controller2=' + '@Model.Controller2';
                               }
                           }
                       }
                       else if (data.Status == 'failure')
                       {
                           $('.spinner').hide();
                           alert('Select Atleast One Record For Ledger.');
                           $("#SaveLedgerPost").prop("disabled", false);
                       }
                       else
                       {
                           $('.spinner').hide();
                           alert(data.html);
                           $("#SaveLedgerPost").prop("disabled", false);
                       }
                   },
               });
            }
        });
    });
</script>



@functions {
    decimal GetAbsolute(decimal dcb)
    {
        var msg = Math.Abs(dcb);
        return msg;
    }

    string GetFixedTwo(decimal dcb)
    {
        decimal d = Math.Floor(100 * dcb) / 100;
        string s = d.ToString("N2");
        return s;
    }
}