@model TFATERPWebApplication.Areas.Accounts.Models.PurchaseVM
@using Common;

<div class="form-horizontal" role="form" style="padding-right:0px;">
    <header class="panel-heading" style="margin-left:0px; background-color:lightgray;color:black;height:22px;padding-top:1px;border-radius:0px;">
        Party Details
    </header>
    <div class="form-group" style="margin-top:5px;">
        <div class="col-sm-6">
            <div class="form-group">
                <label class="col-sm-2 control-label" style="padding-left:25px;">Bill-To Party:</label>
                <div class="col-sm-6">
                    @Html.TextBoxFor(x => x.Account, new { @class = "input-large search-query", @style = "width:100%;margin-top:2px;font-weight:bold;background-color:lightgray;", @id = "Account", @name = "Account" })
                </div>
            </div>
        </div>

        <div id="ShiptoPartyDiv">
            @Html.Partial("ShipParty", Model)
        </div>

    </div>

    <div class="form-group" style="margin-top:5px;">
        <div class="col-sm-6">
            <div class="form-group">
                <label class="col-sm-2 control-label" style="padding-left:25px;">Bill to Address:</label>
                <div class="col-sm-6">
                    @Html.DropDownListFor(x => x.AltAddress, DropdownHelper.EmptyList(), new { @class = "form-control", @id = "AltAddress", @Name = "AltAddress" })
                </div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="form-group">
                <label class="col-sm-2 control-label">Ship to Address:</label>
                <div class="col-sm-6">
                    @Html.DropDownListFor(x => x.DelyAltAdd, DropdownHelper.EmptyList(), new { @class = "form-control", @id = "DelyAltAdd", @Name = "DelyAltAdd", @style = "width:100%;margin-top:2px;" })
                </div>
            </div>
        </div>
    </div>

    <div class="form-group" style="margin-top:5px;">
        <div class="col-sm-6">
            <div class="form-group">
                <div class="col-sm-2"></div>
                <div class="col-sm-6">
                    @Html.TextAreaFor(x => x.AddressFrom, new { @class = "form-control", @id = "AddressFrom", @Name = "AddressFrom", @disabled = "disabled", @style = "height:145px;background-color:#e4e4e4;" })
                </div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="form-group">
                <div class="col-sm-2"></div>
                <div class="col-sm-6">
                    @Html.TextAreaFor(x => x.AddressTo, new { @class = "form-control", @id = "AddressTo", @Name = "AddressTo", @disabled = "disabled", @style = "height:145px;background-color:#e4e4e4;" })
                </div>
            </div>
        </div>
    </div>

    <div class="form-group" style="margin-top:5px;">
        <div class="col-sm-6">
            <div class="form-group">
                <label id="accgstvatnolbl" class="col-sm-2 control-label" style="padding-left:25px;">GST No:</label>
                <div class="col-sm-6">
                    @Html.TextBoxFor(x => x.DisplayGSTId, new { @class = "form-control", @id = "DisplayGSTId", @Name = "DisplayGSTId", @disabled = "disabled" })
                </div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="form-group">
                <label id="delygstvatnolbl" class="col-sm-2 control-label">GST No:</label>
                <div class="col-sm-6">
                    @Html.TextBoxFor(x => x.DisplayGSTId2, new { @class = "form-control", @id = "DisplayGSTId2", @Name = "DisplayGSTId2", @disabled = "disabled" })
                </div>
            </div>
        </div>
    </div>

    <div class="form-group" style="margin-top:5px;">
        <div class="col-sm-6">
            <div class="form-group">
                <label class="col-sm-2 control-label" style="padding-left:25px;">Contact:</label>
                <div class="col-sm-6">
                    @Html.DropDownListFor(x => x.BillContact, DropdownHelper.EmptyList(), new { @class = "form-control", @id = "BillContact", @Name = "BillContact", @style = "width:100%;margin-top:2px;" })
                </div>
            </div>
        </div>
        <div class="col-sm-6">
            <div class="form-group">
                <label class="col-sm-2 control-label">Contact:</label>
                <div class="col-sm-6">
                    @Html.DropDownListFor(x => x.DelyContact, DropdownHelper.EmptyList(), new { @class = "form-control", @id = "DelyContact", @Name = "DelyContact", @style = "width:100%;margin-top:2px;" })
                </div>
            </div>
        </div>
    </div>

    <div class="form-group" style="margin-top:5px;">
        <div class="col-sm-8">
            <label class="col-sm-2 control-label" style="padding-left:10px;">A/C Balance:</label>
            <div class="col-sm-2" style="padding-top:6px;">
                @Html.DisplayFor(x => x.Balance, new { @class = "form-control", @id = "Balance", @Name = "Balance", @style = "width:100%;margin-top:2px;text-align:right;font-weight:bolder;font-size:12pt;color:black;" })
            </div>
            <label class="col-sm-2 control-label" style="padding:unset;">Credit Limit:</label>
            <div class="col-sm-2">
                <label id="CrLimit" style="width:100%;margin-top:2px;"></label>
            </div>
        </div>
    </div>

    <div class="form-group" style="margin-top:5px;">
        <div class="col-sm-6">
            <div class="form-group">
                <label class="col-sm-2 control-label" style="padding-left:25px;">Credit Days:</label>
                <div class="col-sm-3">
                    @Html.TextBoxFor(x => x.CrPeriod, new { @class = "form-control", @id = "CrPeriod", @Name = "CrPeriod", @style = "width:100%;margin-top:2px;text-align:right;" })
                </div>
            </div>
        </div>
    </div>
</div>

@if (Model.ChangeLog != "Add")
{
    <script>
        $(document).ready(function () {
            if ($('#hdnEnableParty').val() == "True" || $('#hdnEnableParty').val() == "true") {
            }
            else {
                 $('#divLedgerTable :input').prop('disabled', true);
            }
            if ($('#IsPickUp').val() == "True" || $('#IsPickUp').val() == "true") {
                $('#divLedgerTable :input').prop('disabled', true);
            }
            LoadAltAddressEdtMd()
            loadDelyAltAddEdtMd()
        });

        function LoadAltAddressEdtMd() {
            $("#AltAddress").empty();
            var url = '@Url.Action("GetAddrSnoList")?Code=' + $("#Account").val();
            $.ajax({
                type: "GET",
                dataType: "json",
                cache: false,
                url: url,
                contentType: "application/json;charset=utf-8",
                beforeSend: function () {
                    $('.spinner').show();
                },
                success: function (result) {
                    $.each(result, function (i, item) {
                        $("#AltAddress").append("<option value='" + item.Value + "'>" + item.Text + "</option>");
                    });
                    $('#AltAddress').val('@Model.AltAddress').attr("selected", "selected");
                    GetAddressFromEdtMd()
                    GetGstId1BySno()
                    GetContAddrSnoList()
                    $('.spinner').hide();
                },

                error: function () {
                    $('.spinner').hide();
                    alert("An error occurred while processing the request.");
                }
            });
        }

        function GetAddressFromEdtMd() {
            var url = '@Url.Action("GetAddressBySno")?Code=' + $("#Account").val() + '&Sno=' + $("#AltAddress").val();
            $.ajax({
                type: "GET",
                dataType: "json",
                cache: false,
                url: url,
                contentType: "application/json;charset=utf-8",
                beforeSend: function () {
                    $('.spinner').show();
                },
                success: function (result) {
                    $('#AddressFrom').text(result);
                    $('.spinner').hide();
                },

                error: function () {
                    $('.spinner').hide();
                    alert("An error occurred while processing the request.");
                }
            });
        }

        function GetAddressToEdtMd() {
            var url = '@Url.Action("GetAddressBySno")?Code=' + $("#Account").val() + '&Sno=' + $("#DelyAltAdd").val() + '&DelyCode=' + $("#DelyCode").val();
            $.ajax({
                type: "GET",
                dataType: "json",
                cache: false,
                url: url,
                contentType: "application/json;charset=utf-8",
                beforeSend: function () {
                    $('.spinner').show();
                },
                success: function (result) {
                    $('#AddressTo').text(result);
                    $('.spinner').hide();
                },
                error: function () {
                    $('.spinner').hide();
                    alert("An error occurred while processing the request.");
                }
            });
        }

        function loadDelyAltAddEdtMd() {
            $("#DelyAltAdd").empty();
            var url = '@Url.Action("GetAddrSnoList")?Code=' + $("#Account").val() + '&DelyCode=' + $("#DelyCode").val();
            $.ajax({
                type: "GET",
                dataType: "json",
                cache: false,
                url: url,
                contentType: "application/json;charset=utf-8",
                beforeSend: function () {
                    $('.spinner').show();
                },
                success: function (result) {
                    $.each(result, function (i, item) {
                        $("#DelyAltAdd").append("<option value='" + item.Value + "'>" + item.Text + "</option>");
                    });
                    $('#DelyAltAdd').val('@Model.DelyAltAdd').attr("selected", "selected");
                    GetAddressToEdtMd()
                    GetDisplayGSTId2ByDely()
                    GetDelyContactByDely()
                    $('.spinner').hide();
                },

                error: function () {
                    $('.spinner').hide();
                    alert("An error occurred while processing the request.");
                }
            });
        }

    </script>
}

<script>
    $(document).ready(function () {
        loadParty();

        if ($('#hdnVATGSTApp').val() == "V") {
            $('#accgstvatnolbl').html('Tax ID');
            $('#delygstvatnolbl').html('Tax ID');
        }

        $('#NotuDate').datepicker({
            format: 'dd-mm-yyyy',
            autoclose: true,
        });
        $('#DelyAltAdd').change(function () {
            GetAddressToByDely()
            GetDisplayGSTId2ByDely()
        });

        $('#Account').change(function () {
            var ModelData = {};
            ModelData["Code"] = $("#Account").val();
            var DTO = { Model: ModelData };
            var url = '@Url.Action("GetPartyDetails")';
            $.ajax({
                type: "POST",
                dataType: "json",
                data: JSON.stringify(DTO),
                cache: false,
                url: url,
                contentType: "application/json;charset=utf-8",
                beforesend: function () {
                    $('.spinner').show();
                },
                success: function (result) {
                    $('#ShiptoPartyDiv').html(result.Html);
                    if ($('#hdnCurrConv').val() == "Y" && $('#hdnAllowCurr').val() != "True") {
                        $('#CurrName').val(result.CurrName).attr("selected", "selected");
                        $('#CurrRate').val(parseFloat(result.CurrRate).toFixed(2))
                    }
                    if ($('#hdnSType').val() == "RP") {
                        $('#hdnAccTDSCode').val(result.TDSCode);
                        if (result.CutTDS == true) {
                            $('#CutTDS').prop('checked', true);
                        }
                        loadTdsCode()
                    }

                    $('#CrPeriod').val(result.CrPeriod);
                    $('#SalesmanCode').val(result.SalesmanCode).attr("selected", "selected");
                    $('#BrokerName').val(result.Broker).attr("selected", "selected");
                    $('#TransporterN').val(result.Transporter).attr("selected", "selected");
                    $('#IncoTerms').val(result.IncoTerms).attr("selected", "selected");
                    $('#PayTerms').val(result.PayTerms).attr("selected", "selected");
                    $('#IncoPlace').val(result.IncoPlace);

                    $('.spinner').hide();
                },

                error: function () {
                    $('.spinner').hide();
                    alert("An error occurred while processing the request.");
                }
            });

            GetAddrSnoList()
            loadDelyAltAddByAcc()
            GetContAddrSnoList()
            LoadDelyContactByAcc()

            GetCrLimit()
            GetBalancePurch()


        });


        $("#AltAddress").change(function () {
            GetAddressByAltAddress()
            GetGstId1BySno()
        });
    });

    function loadParty() {
        var url = '@Url.Action("GetPartyList")?BaseGr=' + $("#hdnMType").val() + '&Code=' + $("#hdnType").val();
        $('#Account').select2({
            minimumInputLength: @Session["MinAcc"],
            placeholder: 'Search',
            ajax:
                {
                    url: url,
                    dataType: 'json',
                    quietMillis: 100,
                    enableFiltering: true,
                    allowClear: true,
                    minimumInputLength: @Session["MinAcc"],
                    multiple: true,
                    width: 300,
                    data: function (term, page) {
                        return {
                            types: ["exercise"],
                            limit: -1, term: term
                        };
                    },
                    results: function (data, page) {
                        clientObj = JSON.stringify(data);
                        return {
                            results: $.map(data, function (item) {
                                return {
                                    text: item.Name, id: item.Code
                                }
                            })
                        };
                    }
                },
            initSelection: function (element, callback) {
                var data = { id: '@Model.Account', text: '@Model.AccountName' };
                callback(data);
            },
            formatResult: function (exercise) {
                return "<div class='row-fluid'><div class=''><span class='span1'><div style='color:" + exercise.alias + "'>" + exercise.text +
                    "</div></span></div></div>";
            },
            formatSelection: function (exercise) {
                return "<div class='row-fluid'><div class=''><span class='span1'><div style='color:" + exercise.alias + "'>" + exercise.text +
                    "</div></span></div></div>";
            },
        })
    };

    function GetAddrSnoList() {
        $("#AltAddress").empty();
        var url = '@Url.Action("GetAddrSnoList")?Code=' + $("#Account").val();
        $.ajax({
            type: "GET",
            dataType: "json",
            cache: false,
            url: url,
            contentType: "application/json;charset=utf-8",
            beforeSend: function () {
                $('.spinner').show();
            },
            success: function (result) {
                $.each(result, function (i, item) {
                    $("#AltAddress").append("<option value='" + item.Value + "'>" + item.Text + "</option>");
                });
                $('#AltAddress').val('@Model.AltAddress').attr("selected", "selected");
                GetAddressByAltAddress()
                GetGstId1BySno()
                $('.spinner').hide();
            },

            error: function () {
                $('.spinner').hide();
                alert("An error occurred while processing the request.");
            }
        });
    }

    function GetContAddrSnoList() {
        $("#BillContact").empty();
        var url = '@Url.Action("GetContactAddrSnoList")?Code=' + $("#Account").val();
        $.ajax({
            type: "GET",
            dataType: "json",
            cache: false,
            url: url,
            contentType: "application/json;charset=utf-8",
            beforeSend: function () {
                $('.spinner').show();
            },
            success: function (result) {
                $.each(result, function (i, item) {
                    $("#BillContact").append("<option value='" + item.Value + "'>" + item.Text + "</option>");
                });
                $('#BillContact').val('@Model.BillContact').attr("selected", "selected");
                $('.spinner').hide();
            },

            error: function () {
                $('.spinner').hide();
                alert("An error occurred while processing the request.");
            }
        });
    }

    function GetDelyContactrSnoList() {
        $("#DelyContact").empty();
        var url = '@Url.Action("GetContactAddrSnoList")?Code=' + $("#Account").val() + '&DelyCode=' +  $("#hdnDelyCode").val();
        $.ajax({
            type: "GET",
            dataType: "json",
            cache: false,
            url: url,
            contentType: "application/json;charset=utf-8",
            beforeSend: function () {
                $('.spinner').show();
            },
            success: function (result) {
                $.each(result, function (i, item) {
                    $("#DelyContact").append("<option value='" + item.Value + "'>" + item.Text + "</option>");
                });
                $('#DelyContact').val('@Model.DelyContact').attr("selected", "selected");
                $('.spinner').hide();
            },

            error: function () {
                $('.spinner').hide();
                alert("An error occurred while processing the request.");
            }
        });
    }

    function GetAddressByAltAddress() {
        var url = '@Url.Action("GetAddressBySno")?Code=' + $("#Account").val() + '&Sno=' + $("#AltAddress").val();
        $.ajax({
            type: "GET",
            dataType: "json",
            cache: false,
            url: url,
            contentType: "application/json;charset=utf-8",
            beforeSend: function () {
                $('.spinner').show();
            },
            success: function (result) {
                $('#AddressFrom').text(result);
                $('.spinner').hide();
            },

            error: function () {
                $('.spinner').hide();
                alert("An error occurred while processing the request.");
            }
        });
    }


    function GetGstId1BySno() {
        var url = '@Url.Action("PopulateGSTIDByAcc")?Code=' + $("#Account").val() + '&Sno=' + $("#AltAddress").val() + '&VATGSTApp=' + $("#hdnVATGSTApp").val();
        $.ajax({
            type: "GET",
            dataType: "json",
            cache: false,
            url: url,
            contentType: "application/json;charset=utf-8",
            beforeSend: function () {
                $('.spinner').show();
            },
            success: function (result) {
                $('#DisplayGSTId').val(result.DisplayGSTId);
                $('.spinner').hide();
            },

            error: function () {
                $('.spinner').hide();
                alert("An error occurred while processing the request.");
            }
        });
    }

    function GetCrLimit() {
        var url = '@Url.Action("GetCreditLimit")?Party=' + $("#Account").val();
        $.ajax({
            type: "GET",
            dataType: "json",
            cache: false,
            url: url,
            contentType: "application/json;charset=utf-8",
            beforeSend: function () {
                $('.spinner').show();
            },
            success: function (result) {
                $('#CrLimit').html(result.CrLimit);
                $('#CrPeriod').html(result.CrPeriod);
                $('.spinner').hide();
            },

            error: function () {
                $('.spinner').hide();
                alert("An error occurred while processing the request.");
            }
        });
    }
    function GetBalancePurch() {
        var url = '@Url.Action("GetBalanceOnPurchase")?Party=' + $("#Account").val();
        $.ajax({
            type: "GET",
            dataType: "json",
            cache: false,
            url: url,
            contentType: "application/json;charset=utf-8",
            beforeSend: function () {
                $('.spinner').show();
            },
            success: function (result) {
                $('#Balance').html(result.Balance);
                $('.spinner').hide();
            },

            error: function () {
                $('.spinner').hide();
                alert("An error occurred while processing the request.");
            }
        });
    }

    function loadDelyAltAddByAcc() {
        $("#DelyAltAdd").empty();
        var url = '@Url.Action("GetDelyAltAddByAcc")?Code=' + $("#Account").val();
        $.ajax({
            type: "GET",
            dataType: "json",
            cache: false,
            url: url,
            contentType: "application/json;charset=utf-8",
            beforeSend: function () {
                $('.spinner').show();
            },
            success: function (result) {
                $.each(result, function (i, item) {
                    $("#DelyAltAdd").append("<option value='" + item.Value + "'>" + item.Text + "</option>");
                });
                $('select[name="DelyAltAdd"] option:first').prop('selected', 'selected');
                loadAddressToByAcc()
                LoadDisplayGSTID2ByAcc()
                $('.spinner').hide();
            },

            error: function () {
                $('.spinner').hide();
                alert("An error occurred while processing the request.");
            }
        });
    }

    function loadAddressToByAcc() {
        var url = '@Url.Action("GetAddressBySno")?Code=' + $("#Account").val() + '&Sno=' + $("#DelyAltAdd").val();
        $.ajax({
            type: "GET",
            dataType: "json",
            cache: false,
            url: url,
            contentType: "application/json;charset=utf-8",
            beforeSend: function () {
                $('.spinner').show();
            },
            success: function (result) {
                $('#AddressTo').text(result);
                $('.spinner').hide();
            },

            error: function () {
                $('.spinner').hide();
                alert("An error occurred while processing the request.");
            }
        });
    }

    function LoadDisplayGSTID2ByAcc() {
        var url = '@Url.Action("PopulateGSTIDByAcc")?Code=' + $("#Account").val() + '&Sno=' + $("#DelyAltAdd").val() + '&VATGSTApp=' + $("#hdnVATGSTApp").val();
        $.ajax({
            type: "GET",
            dataType: "json",
            cache: false,
            url: url,
            contentType: "application/json;charset=utf-8",
            beforeSend: function () {
                $('.spinner').show();
            },
            success: function (result) {
                $('#DisplayGSTId2').val(result.DisplayGSTId);
                $('.spinner').hide();
            },

            error: function () {
                $('.spinner').hide();
                alert("An error occurred while processing the request.");
            }
        });
    }


    function LoadDelyContactByAcc() {
        $("#DelyContact").empty();
        var url = '@Url.Action("GetDelyContactByAcc")?Code=' + $("#Account").val();
        $.ajax({
            type: "GET",
            dataType: "json",
            cache: false,
            url: url,
            contentType: "application/json;charset=utf-8",
            beforeSend: function () {
                $('.spinner').show();
            },
            success: function (result) {
                $.each(result, function (i, item) {
                    $("#DelyContact").append("<option value='" + item.Value + "'>" + item.Text + "</option>");
                });
                $('select[name="DelyContact"] option:first').prop('selected', 'selected');
                $('.spinner').hide();
            },

            error: function () {
                $('.spinner').hide();
                alert("An error occurred while processing the request.");
            }
        });
    }
</script>
@Html.HiddenFor(x => x.Account, new { @id = "hdnAccountId" })
@Html.HiddenFor(x => x.AccountName, new { @id = "hdnAccountName" })
@Html.HiddenFor(x => x.TDSCode, new { @id = "hdnAccTDSCode" })