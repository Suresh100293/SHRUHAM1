@model TFATERPWebApplication.Areas.Accounts.Models.PurchaseVM

<div class="modal-content">
    <div class="modal-header" style="background-color:#cccccc">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"></span></button>
        <h4 class="modal-title">Stock Batch Details</h4>
    </div>
    @if (Model.SubType == "RP" || Model.SubType == "CP" || Model.SubType == "IM" || Model.SubType == "NS" || Model.SubType == "IC" || Model.SubType == "SX")
    {
        <script>
            $(document).ready(function () {

                $('#txtMfgDateedt').datepicker({
                    format: 'dd-mm-yyyy',
                    autoclose: true,
                });

                $('#txtExpDateedt').datepicker({
                    format: 'dd-mm-yyyy',
                    autoclose: true,
                });

                $('.batchmfgdtclassedt').datepicker({
                    format: 'dd-mm-yyyy',
                    autoclose: true,
                });

                $('.batchexpdtclassedt').datepicker({
                    format: 'dd-mm-yyyy',
                    autoclose: true,
                });

                $('#btnadddBatchStkEdt').click(function (event) {
                    event.preventDefault();
                    if (CheckBatchValidationOnFirstAdd2() == false) {
                        return;
                    }
                    var myBatchArray = []
                    $('#ItmBtPREdt tbody tr').each(function () {
                        var tds = $(this).find('td');
                        var myDets = {
                            tempId: tds.eq(0).text(),
                            Batch: tds.eq(1).text(),
                            Qty: tds.eq(2).text(),
                            Qty2: tds.eq(3).text(),
                            MRP: tds.eq(4).text(),
                            Rate: tds.eq(5).text(),
                            StrMfgDate: tds.find("input[id='typemfgdate']").val(),
                            StrExpDate: tds.find("input[id='typeexpdate']").val(),
                            Code: tds.eq(8).text(),
                            MainType: tds.eq(9).text(),
                            SubType: tds.eq(10).text(),
                            Store: tds.eq(11).text(),
                        }
                        myBatchArray.push(myDets);
                    })

                    var ModelData = {};
                    ModelData["BatchNo"] = $("#txtBatchNoedt").val();
                    ModelData["Qty"] = $("#txtQty11edt").val();
                    ModelData["Qty2"] = $("#txtbatchQty2edt").val();
                    ModelData["MRP"] = $("#txtMRPedt").val();
                    ModelData["Rate"] = $('#txtRate11edt').val();
                    ModelData["StrMfgDate"] = $('#txtMfgDateedt').val();
                    ModelData["StrExpDate"] = $('#txtExpDateedt').val();
                    ModelData["SubType"] = $("#hdnSType").val();
                    ModelData["MainType"] = $("#hdnMType").val();
                    ModelData["Store"] = $("#HdnItmBatchStore").val();
                    ModelData["Code"] = $("#HdnItmBatchCode").val();
                    ModelData["ChangeLog"] = $("#hdnchangelog").val();
                    ModelData["HdnItmBatch"] = $("#HdnItmBatch").val();
                    ModelData["ItemBatchListPS"] = myBatchArray;
                    ModelData["ProductQty"] = $("#HdnEdtProductQty").val();
                    ModelData["ProductQty2"] = $("#HdnEdtProductQty2").val();
                    ModelData["ProductRateOn2"] = $("#HdnEdtProductRateOn2").val();
                    var DTO = { Model: ModelData };
                    var url = '@Url.Action("SessItemBatchLstPurch")';
                    $.ajax({
                        type: "POST",
                        dataType: "json",
                        data: JSON.stringify(DTO),
                        cache: false,
                        url: url,
                        contentType: "application/json;charset=utf-8",
                        beforeSend: function () {
                            $('.spinner').show();
                        },
                        success: function (data) {
                            $('.spinner').hide();
                            $('#addedtitembatch').modal('show');
                            if (data.Status == "Success") {
                                $('#addedtItemBatch').html(data.Html);
                            }
                            if (data.Status == "Duplicate") {
                                alert('Duplicate Batch Number ' + data.Message + "")
                            }
                        },
                        error: function () {
                            alert("Error occured while processing your request.");
                        }
                    });
                });


                $('#LastBatchDPurch').click(function (event) {
                    event.preventDefault();
                    if (CheckBatchValidation2() == false) {
                        return;
                    }
                    var myBatchArray = []
                    $('#ItmBtPREdt tbody tr').each(function () {
                        var tds = $(this).find('td');
                        var myDets = {
                            tempId: tds.eq(0).text(),
                            Batch: tds.eq(1).text(),
                            Qty: tds.eq(2).text(),
                            Qty2: tds.eq(3).text(),
                            MRP: tds.eq(4).text(),
                            Rate: tds.eq(5).text(),
                            StrMfgDate: tds.find("input[id='typemfgdate']").val(),
                            StrExpDate: tds.find("input[id='typeexpdate']").val(),
                            Code: tds.eq(8).text(),
                            MainType: tds.eq(9).text(),
                            SubType: tds.eq(10).text(),
                            Store: tds.eq(11).text(),
                        }
                        myBatchArray.push(myDets);
                    })
                    var ModelData = {};
                    ModelData["ItemBatchListPS"] = myBatchArray;
                    ModelData["HdnItmBatch"] = $("#HdnItmBatch").val();
                    ModelData["SubType"] = $("#hdnSType").val();
                    ModelData["ChangeLog"] = $("#hdnchangelog").val();
                    ModelData["MainType"] = $("#hdnMType").val();
                    ModelData["ProductQty"] = $("#HdnEdtProductQty").val();
                    ModelData["ProductQty2"] = $("#HdnEdtProductQty2").val();
                    ModelData["ProductRateOn2"] = $("#HdnEdtProductRateOn2").val();
                    var DTO = { Model: ModelData };
                    var url = '@Url.Action("SessFinalItemBatchList")';
                    $.ajax({
                        type: "POST",
                        dataType: "json",
                        data: JSON.stringify(DTO),
                        cache: false,
                        url: url,
                        contentType: "application/json;charset=utf-8",
                        beforeSend: function () {
                            $('.spinner').show();
                        },
                        success: function (data) {
                            $('.spinner').hide();
                            $('#addedtitembatch').modal('hide');

                        },
                        error: function () {
                            alert("Error occured while processing your request.");
                        }
                    });
                });

                $('button[action|="DeleteBatch"]').click(function (event) {
                    event.preventDefault();
                    var myBatchArray = []
                    $('#ItmBtPREdt tbody tr').each(function () {
                        var tds = $(this).find('td');
                        var myDets = {
                            tempId: tds.eq(0).text(),
                            Batch: tds.eq(1).text(),
                            Qty: tds.eq(2).text(),
                            Qty2: tds.eq(3).text(),
                            MRP: tds.eq(4).text(),
                            Rate: tds.eq(5).text(),
                            StrMfgDate: tds.find("input[id='typemfgdate']").val(),
                            StrExpDate: tds.find("input[id='typeexpdate']").val(),
                            Code: tds.eq(8).text(),
                            MainType: tds.eq(9).text(),
                            SubType: tds.eq(10).text(),
                            Store: tds.eq(11).text(),
                        }
                        myBatchArray.push(myDets);
                    })

                    var ModelData = {};
                    ModelData["tempId"] = $(this).val();
                    ModelData["ItemBatchListPS"] = myBatchArray;
                    ModelData["SubType"] = $("#hdnSType").val();
                    ModelData["ChangeLog"] = $("#hdnchangelog").val();
                    ModelData["ProductQty"] = $("#HdnEdtProductQty").val();
                    ModelData["ProductQty2"] = $("#HdnEdtProductQty2").val();
                    ModelData["ProductRateOn2"] = $("#HdnEdtProductRateOn2").val();
                    ModelData["HdnItmBatch"] = $("#HdnItmBatch").val();
                    ModelData["Code"] = $("#HdnItmBatchCode").val();
                    ModelData["Store"] = $("#HdnItmBatchStore").val();
                    var DTO = { Model: ModelData };
                    var url = '@Url.Action("DeleteItemBatchInEditMode")';
                    $.ajax({
                        type: "POST",
                        dataType: "json",
                        data: JSON.stringify(DTO),
                        cache: false,
                        url: url,
                        contentType: "application/json;charset=utf-8",
                        beforeSend: function () {
                            $('.spinner').show();
                        },
                        success: function (data) {
                            $('.spinner').hide();
                            $('#addedtitembatch').modal('show');
                            $('#addedtItemBatch').html(data.Html);
                        },
                        error: function () {
                            alert("Error occured while processing your request.");
                        }
                    });
                });
            });
            function CheckBatchValidation2() {
                var adjsum1 = 0;
                var adjsum2 = 0;
                var rateonbool = $('#HdnEdtProductRateOn2').val();
                var batchqty2 = parseFloat($('#HdnEdtProductQty2').val());
                var batchqty1 = parseFloat($('#HdnEdtProductQty').val());
                if (rateonbool == "False") {
                    $('#ItmBtPREdt tbody tr').each(function () {
                        var tds = $(this).find('td');
                        var Qty = tds.eq(2).text();
                        adjsum1 += (parseFloat(Qty));
                    })
                    if (batchqty1 != adjsum1) {
                        alert('Product Qty1 is not equal to Batch Qty1')

                        return false;
                    }
                    else {
                        return true;
                    }


                }
                else {
                    $('#ItmBtPREdt tbody tr').each(function () {
                        var tds = $(this).find('td');
                        var Qty2 = tds.eq(3).text();
                        adjsum2 += (parseFloat(Qty2));
                    })
                    if (batchqty2 != adjsum2) {
                        alert('Product Qty2 is not equal to Batch Qty2')

                        return false;
                    }
                    else {
                        return true;
                    }

                }

            }

            function CheckBatchValidationOnFirstAdd2() {
                var adjsum1 = 0;
                var adjsum2 = 0;
                var rateonbool = $('#HdnEdtProductRateOn2').val();
                var batchqty2 = parseFloat($('#HdnEdtProductQty2').val());
                var batchqty1 = parseFloat($('#HdnEdtProductQty').val());
                if (rateonbool == "False") {
                    adjsum1 = parseFloat($('#txtQty11edt').val());
                    if (batchqty1 < adjsum1) {
                        alert('Product Qty1 is less than Batch Qty1')

                        return false;

                    }
                    else {
                        return true;
                    }

                }
                else {
                    adjsum2 = parseFloat($('#txtbatchQty2edt').val());

                    if (batchqty2 < adjsum2) {
                        alert('Product Qty2 is less than Batch Qty2')

                        return false;
                    }
                    else {
                        return true;
                    }

                }

            }

        </script>
        <div class="modal-body">
            Quantity: @Html.DisplayFor(x => x.ProductQty, new { @class = "form-control", @style = "text-align:right;font-weight:bold;" })  Quantity2: @Html.DisplayFor(x => x.ProductQty2)
            <div id="divItmBtPREdt" class="grid" style="max-height:350px;min-height:350px; width:100%; overflow: scroll;">
                <table id="ItmBtPREdt" class="zui-tableww">
                    <thead>
                        <tr role="row" style="font-family:Tahoma;font-size:9pt;">
                            <th>Sr.</th>
                            <th>Batch Number</th>
                            <th>Qty</th>
                            <th>Qty2</th>
                            <th>MRP</th>
                            <th>Rate</th>
                            <th>Mfg.Date</th>
                            <th>Exp.Date</th>
                            <th hidden="hidden"></th>
                            <th hidden="hidden"></th>
                            <th hidden="hidden"></th>
                            <th hidden="hidden"></th>
                            <th></th>
                        </tr>
                        <tr>
                            <td></td>
                            <td>@Html.TextBoxFor(x => x.BatchNo, new { @type = "text", @id = "txtBatchNoedt", @style = "width:99%;margin-top:2px;" })</td>
                            <td>@Html.TextBoxFor(x => x.Qty, new { @type = "text", @id = "txtQty11edt", @style = "width:99%;margin-top:2px;text-align:right;" })</td>
                            <td>@Html.TextBoxFor(x => x.Qty2, new { @type = "text", @id = "txtbatchQty2edt", @style = "width:99%;margin-top:2px;text-align:right;" })</td>
                            <td>@Html.TextBoxFor(x => x.MRP, new { @type = "text", @id = "txtMRPedt", @style = "width:99%;margin-top:2px;text-align:right;" })</td>
                            <td>@Html.TextBoxFor(x => x.Rate, new { @type = "text", @id = "txtRate11edt", @style = "width:99%;margin-top:2px;text-align:right;" })</td>
                            <td>@Html.TextBoxFor(x => x.StrMfgDate, new { @type = "text", @id = "txtMfgDateedt", @style = "width:99%;margin-top:2px;height:25px;", @Value = DateTime.Now.ToString("dd-MM-yyyy") })</td>
                            <td>@Html.TextBoxFor(x => x.StrExpDate, new { @type = "text", @id = "txtExpDateedt", @style = "width:99%;margin-top:2px;height:25px;", @Value = DateTime.Now.ToString("dd-MM-yyyy") })</td>
                            <td hidden="hidden"></td>
                            <td hidden="hidden"></td>
                            <td hidden="hidden"></td>
                            <td hidden="hidden"></td>
                            <td><a id="btnadddBatchStkEdt" href="#" class="btn btn-primary btn-sm" title="Add"><i class="fa fa-plus"></i></a></td>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.ItemBatchListPS != null)
                        {
                            for (int i = 0; i < Model.ItemBatchListPS.Count; i++)
                            {
                                <tr>
                                    <td style="text-align:right">@Html.DisplayFor(m => Model.ItemBatchListPS[i].tempId)</td>
                                    <td contenteditable="true">@Html.DisplayFor(m => Model.ItemBatchListPS[i].Batch)</td>
                                    <td style="text-align:right" contenteditable="true">@Html.DisplayFor(m => Model.ItemBatchListPS[i].Qty)</td>
                                    <td style="text-align:right" contenteditable="true">@Html.DisplayFor(m => Model.ItemBatchListPS[i].Qty2)</td>
                                    <td>@Html.DisplayFor(m => Model.ItemBatchListPS[i].MRP)</td>
                                    <td>@Html.DisplayFor(m => Model.ItemBatchListPS[i].Rate)</td>
                                    <td style="text-align:right" contenteditable="true">@Html.TextBoxFor(m => Model.ItemBatchListPS[i].StrMfgDate, new { @class = "batchmfgdtclassedt", @id = "typemfgdate" })</td>
                                    <td style="text-align:right" contenteditable="true">@Html.TextBoxFor(m => Model.ItemBatchListPS[i].StrExpDate, new { @class = "batchexpdtclassedt", @id = "typeexpdate" })</td>
                                    <td hidden="hidden">@Html.DisplayFor(m => Model.ItemBatchListPS[i].Code)</td>
                                    <td hidden="hidden">@Html.DisplayFor(m => Model.ItemBatchListPS[i].MainType)</td>
                                    <td hidden="hidden">@Html.DisplayFor(m => Model.ItemBatchListPS[i].SubType)</td>
                                    <td hidden="hidden">@Html.DisplayFor(m => Model.ItemBatchListPS[i].Store)</td>
                                    <td><button type="button" action="DeleteBatch" class="btn btn-danger btn-sm" value="@Html.DisplayFor(m => Model.ItemBatchListPS[i].tempId)" title="Delete"><i class="fa fa-trash-o"></i></button></td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer" style="background-color:#cccccc">
            <button type="button" class="btn btn-success" id="LastBatchDPurch">Save</button>
            <button type="button" class="btn btn-danger" id="CloseUpdBatch">Close</button>
        </div>
        @Html.HiddenFor(x => x.HdnItmBatch, new { @id = "HdnItmBatch" })
        @Html.HiddenFor(x => x.Code, new { @id = "HdnItmBatchCode" })
        @Html.HiddenFor(x => x.Store, new { @id = "HdnItmBatchStore" })
    }
    @if (Model.SubType == "RS" || Model.SubType == "CS" || Model.SubType == "XS" || Model.SubType == "NP" || Model.SubType == "OC" || Model.SubType == "PX")
    {
        <script>
            $(document).ready(function () {
                $('#UpdateBatchDSales').click(function (event) {
                    event.preventDefault();
                    if (CheckBatchValidationOnSLEdit() == false) {
                        return;
                    }
                    var myTableArray = [];
                    $('#itembatchSLEdt tr:not(:first)').each(function () {
                        if ($(this).find('input[type="checkbox"]').is(':checked')) {
                            var tds = $(this).find('td');
                            var myDets = {
                                tempId: tds.eq(1).text(),
                                Batch: tds.eq(2).text(),
                                UseQty: tds.eq(3).text(),
                                Qty2: tds.eq(4).text(),
                                Balance: tds.eq(5).text(),
                                MRP: tds.eq(6).text(),
                                Rate: tds.eq(7).text(),
                                StrMfgDate: tds.eq(8).text(),
                                StrExpDate: tds.eq(9).text(),
                                Code: tds.eq(10).text(),
                                MainType: tds.eq(11).text(),
                                SubType: tds.eq(12).text(),
                                Store: tds.eq(13).text(),
                            }
                            myTableArray.push(myDets);
                        }
                    })
                    var ModelData = {};
                    ModelData["ItemBatchListPS"] = myTableArray;
                    ModelData["ChangeLog"] = $("#hdnchangelog").val();
                    ModelData["SubType"] = $("#hdnSType").val();
                    ModelData["MainType"] = $("#hdnMType").val();
                    ModelData["tempId"] = $("#HdnItmBatch").val();
                    var DTO = { Model: ModelData };
                    var url = '@Url.Action("SessItemBatchLstSales")';
                    $.ajax({
                        type: "POST",
                        dataType: "json",
                        data: JSON.stringify(DTO),
                        cache: false,
                        url: url,
                        contentType: "application/json;charset=utf-8",
                        beforesend: function () {
                            $('.spinner').show();
                        },
                        success: function (data) {
                            $('.spinner').hide();
                            $('#addedtitembatch').modal('hide');
                        },
                        error: function () {
                            $('.spinner').hide();
                            alert("error occured while processing your request.");
                        }
                    });

                });

            });
            function CheckBatchValidationOnSLEdit() {
                var adjsum1 = 0;
                var adjsum2 = 0;
                var EndResult = true;
                var rateonbool = $('#HdnEdtProductRateOn2').val();
                var batchqty2 = parseFloat($('#HdnEdtProductQty2').val());
                var batchqty1 = parseFloat($('#HdnEdtProductQty').val());
                if (rateonbool == "False") {
                    $('#itembatchSLEdt tr:not(:first)').each(function () {
                        if ($(this).find('input[type="checkbox"]').is(':checked')) {
                            var tds = $(this).find('td');
                            var Qty = parseFloat(tds.eq(3).text());
                            var BalQty = parseFloat(tds.eq(5).text());
                            if (Qty <= 0) {
                                alert('Selected Batch Quantity is zero')
                                EndResult = false;
                            }
                            if (Qty > BalQty) {
                                alert('Selected Batch Quantity is greater than Balance Qty')
                                EndResult = false;
                            }
                            adjsum1 += (parseFloat(Qty));
                        }
                    })
                    if (EndResult == false) {
                        return false;
                    }
                    if (batchqty1 < adjsum1) {
                        alert('Product Qty1 is less than Batch Qty1')

                        return false;

                    }
                    else {
                        return true;
                    }


                }
                else {
                    $('#itembatchSLEdt tr:not(:first)').each(function () {
                        if ($(this).find('input[type="checkbox"]').is(':checked')) {
                            var tds = $(this).find('td');
                            var Qty2 = parseFloat(tds.eq(4).text());
                            var BalQty = parseFloat(tds.eq(5).text());
                            if (Qty2 <= 0) {
                                alert('Selected Batch Quantity2 is zero')
                                EndResult = false;
                            }
                            if (Qty2 > BalQty) {
                                alert('Selected Batch Quantity2 is greater than Balance Qty')
                                EndResult = false;
                            }
                            adjsum2 += (parseFloat(Qty2));
                        }
                    })
                    if (EndResult == false) {
                        return false;
                    }
                    if (batchqty2 < adjsum2) {
                        alert('Product Qty2 is less than Batch Qty2')

                        return false;
                    }
                    else {
                        return true;
                    }

                }

            }
        </script>
        <div class="modal-body">
            Quantity: @Html.DisplayFor(x => x.ProductQty, new { @class = "form-control", @style = "text-align:right;font-weight:bold;" })  Quantity2: @Html.DisplayFor(x => x.ProductQty2)
            <div class="divitembatchSLEdt" style="max-height:350px;min-height:350px; width:100%; overflow: scroll;">
                <table id="itembatchSLEdt" class="zui-tableww" style="width:100%;">
                    <thead>
                        <tr role="row" style="font-family:Tahoma;font-size:9pt;">
                            <th></th>
                            <th>Sr.</th>
                            <th>Batch Number</th>
                            <th>Qty</th>
                            <th>Qty2</th>
                            <th>Balance</th>
                            <th>MRP</th>
                            <th>Rate</th>
                            <th>Mfg.Date</th>
                            <th>Exp.Date</th>
                            <th hidden="hidden"></th>
                            <th hidden="hidden"></th>
                            <th hidden="hidden"></th>
                            <th hidden="hidden"></th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.ItemBatchListPS != null)
                        {
                            for (int i = 0; i < Model.ItemBatchListPS.Count; i++)
                            {
                                <tr>
                                    <td>@Html.CheckBoxFor(m => Model.ItemBatchListPS[i].ExistData, new { @value = Model.ItemBatchListPS[i].Batch, @id = "ExistBatchData", @name = "ExistBatchData" })</td>
                                    <td> @Html.DisplayFor(m => Model.ItemBatchListPS[i].tempId)</td>
                                    <td>@Html.DisplayFor(m => Model.ItemBatchListPS[i].Batch)</td>
                                    <td contenteditable="true" style="text-align:right;" id="useqty">@Html.DisplayFor(m => Model.ItemBatchListPS[i].UseQty)</td>
                                    <td contenteditable="true" style="text-align:right;" id="useqty2">@Html.DisplayFor(m => Model.ItemBatchListPS[i].Qty2)</td>
                                    <td style="text-align:right">@Html.DisplayFor(m => Model.ItemBatchListPS[i].Balance)</td>
                                    <td>@Html.DisplayFor(m => Model.ItemBatchListPS[i].MRP)</td>
                                    <td>@Html.DisplayFor(m => Model.ItemBatchListPS[i].Rate)</td>
                                    <td>@Html.DisplayFor(m => Model.ItemBatchListPS[i].StrMfgDate)</td>
                                    <td>@Html.DisplayFor(m => Model.ItemBatchListPS[i].StrExpDate)</td>
                                    <td hidden="hidden">@Html.DisplayFor(m => Model.ItemBatchListPS[i].Code)</td>
                                    <td hidden="hidden">@Html.DisplayFor(m => Model.ItemBatchListPS[i].MainType)</td>
                                    <td hidden="hidden">@Html.DisplayFor(m => Model.ItemBatchListPS[i].SubType)</td>
                                    <td hidden="hidden">@Model.ItemBatchListPS[i].Store</td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer" style="background-color:#cccccc">
            <button type="button" class="btn btn-success" id="UpdateBatchDSales">OK</button>
            <button type="button" class="btn btn-danger" id="CloseUpdBatch">Close</button>
        </div>
        @Html.HiddenFor(x => x.HdnItmBatch, new { @id = "HdnItmBatch" })
    }
</div>

@Html.HiddenFor(x => x.ProductQty, new { @id = "HdnEdtProductQty" })
@Html.HiddenFor(x => x.ProductQty2, new { @id = "HdnEdtProductQty2" })
@Html.HiddenFor(x => x.ProductRateOn2, new { @id = "HdnEdtProductRateOn2" })
<input type="hidden" id="Ihdncode" name="Ihdncode" />
<input type="hidden" id="IhdnsubT" name="IhdnsubT" />
<input type="hidden" id="IhdnMainT" name="IhdnMainT" />
<script>
    $(document).ready(function () {
        $('#CloseUpdBatch').click(function (event) {
            event.preventDefault();
            $('#addedtitembatch').modal('hide');
        });
    });
</script>