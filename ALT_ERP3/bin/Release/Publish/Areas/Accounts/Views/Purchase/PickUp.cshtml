@model TFATERPWebApplication.Areas.Accounts.Models.PurchaseVM
@using Common;

<div class="modal-body">
    <div class="modal-content">
        <div class="modal-header" style="background-color:#cccccc;padding:7px;font-weight:bolder;">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"></span></button>
            <h4 class="modal-title">Pick from Source Document</h4>
        </div>
        <div class="modal-body">
            <div class="grid" id="PickTable" style="max-height:450px; min-height:450px;width:100%; overflow: scroll;">

                @if (Model.MileStoneReqd == true)
                {
                    <table id="tabledatapick" class="zui-table">
                        <thead>
                            <tr role="row">
                                <th></th>
                                <th style="width:1%">Sr.</th>
                                <th style="width:10%">Ord Date</th>
                                <th style="width:10%">Stage</th>
                                <th style="width:10%">MSTPer</th>
                                <th style="width:10%">PayStage</th>
                                <th style="width:10%">PayPercent</th>
                                <th style="width:5%">TableKey</th>
                                <th style="width:5%">ParentKey</th>

                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.NewItemList != null)
                            {
                                foreach (var item in @Model.NewItemList.Where(x => x.tempIsDeleted == false).ToList())
                                {
                                    <tr style="font-family:Tahoma;font-size:9pt;border: solid 1px lightgray;">
                                        <td style="width:1%"><input id='rolemaster_AccessType" + rowId + "' type='radio' name='radAnswer' Class='example2' /></td>
                                        <td style="width:1%">@item.tempId</td>
                                        <td style="width:5%">@item.BillDate.ToString("dd/MM/yyyy")</td>
                                        <td hidden="hidden">@item.StageName</td>
                                        <td style="width:5%">@item.Stage</td>
                                        <td style="width:5%">@item.MSTPer</td>
                                        <td style="width:5%">@item.PayStage</td>
                                        <td style="width:5%">@item.PayPercent</td>
                                        <td style="width:5%">@item.TableKey</td>
                                        <td style="width:5%">@item.ParentKey</td>

                                        <td hidden="hidden">@item.MainType</td>
                                        <td hidden="hidden">@item.SubType</td>


                                        @*<td hidden="hidden">@item.IndKey</td>
                                            <td hidden="hidden">@item.EnqKey</td>
                                            <td hidden="hidden">@item.QtnKey</td>
                                            <td hidden="hidden">@item.OrdKey</td>
                                            <td hidden="hidden">@item.ChlnKey</td>
                                            <td hidden="hidden">@item.InvKey</td>
                                            <td hidden="hidden">@item.PKSKey</td>*@

                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <table id="tabledatapick" class="zui-table">
                        <thead>
                            <tr role="row">
                                <th></th>
                                <th style="width:1%">Sr.</th>
                                <th style="width:5%">TableKey</th>
                                <th style="width:5%">ParentKey</th>
                                <th style="width:5%">Ord Date</th>
                                <th style="width:10%">Item Code</th>
                                <th style="width:10%">Item Description</th>
                                <th style="width:20%;">Store</th>
                                <th style="width:20%;">Unit</th>
                                <th style="width:5%">HSN</th>
                                <th style="width:5%">GST Code</th>
                                <th style="width:5%">Qty</th>
                                <th style="width:5%">Factor</th>
                                <th style="width:5%">Qty2</th>
                                <th style="width:5%">Unit2</th>
                                <th style="width:5%">RateOn2</th>
                                <th style="width:5%">Rate</th>
                                <th style="width:5%">Disc%</th>
                                <th style="width:5%">Disc.Amt</th>
                                <th style="width:5%"><label id="igstvatrpostlbl">IGSTRate</label></th>
                                <th style="width:5%"><label id="cgstvatrpostlbl">CGSTRate</label></th>
                                <th style="width:5%"><label id="sgstvatrpostlbl">SGSTRate</label></th>
                                <th style="width:5%"><label id="igstvatapostlbl">IGSTAmt</label></th>
                                <th style="width:5%"><label id="cgstvatapostlbl">CGSTAmt</label></th>
                                <th style="width:5%"><label id="sgstvatapostlbl">SGSTAmt</label></th>
                                <th style="width:5%">Taxable</th>
                                <th style="width:5%">Val1</th>

                                <th style="width:15%">Narration</th>
                                <th style="width:5%">BinNumber</th>

                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.NewItemList != null)
                            {
                                foreach (var item in @Model.NewItemList.Where(x => x.tempIsDeleted == false).ToList())
                                {
                                    <tr style="font-family:Tahoma;font-size:9pt;border: solid 1px lightgray;">
                                        <td><input type="checkbox" id='rolemaster_AccessType' atr="@item.SrNo" value="@item.tempId" /></td>
                                        <td style="width:1%">@item.tempId</td>
                                        <td style="width:5%">@item.TableKey</td>
                                        <td style="width:5%">@item.ParentKey</td>
                                        <td style="width:5%">@item.BillDate.ToString("dd/MM/yyyy")</td>
                                        <td style="width:10%;">@item.Code</td>
                                        <td style="width:10%;">@item.ItemName</td>
                                        <td style="width:10%;">@item.Store</td>
                                        <td style="width:10%;">@item.Unit</td>
                                        <td style="width:10%;text-align:right;">@item.HSN</td>
                                        <td style="width:10%;">@item.GSTCode</td>
                                        <td style="width:10%;">@item.Qty</td>
                                        <td style="width:10%;">@item.Factor</td>
                                        <td style="width:10%;">@item.Qty2</td>
                                        <td style="width:5%">@item.Unit2</td>
                                        <td style="width:5%">@item.RateOn2</td>
                                        <td style="width:10%;">@item.Rate</td>
                                        <td style="width:10%;">@item.Disc</td>
                                        <td style="width:10%;">@item.DiscAmt</td>
                                        <td style="width:5%">@item.IGSTRate</td>
                                        <td style="width:5%">@item.CGSTRate</td>
                                        <td style="width:5%">@item.SGSTRate</td>
                                        <td style="width:5%">@item.IGSTAmt</td>
                                        <td style="width:5%">@item.CGSTAmt</td>
                                        <td style="width:5%">@item.SGSTAmt</td>
                                        <td style="width:5%">@item.Taxable</td>
                                        <td style="width:5%">@item.Val1</td>
                                        <td style="width:15%">@item.Narr</td>
                                        <td style="width:5%">@item.BinNumber</td>
                                        <td hidden="hidden">@item.MainType</td>
                                        <td hidden="hidden">@item.SubType</td>
                                        <td hidden="hidden">@item.DiscPerAmt</td>

                                        <td hidden="hidden">@item.IndKey</td>
                                        <td hidden="hidden">@item.EnqKey</td>
                                        <td hidden="hidden">@item.QtnKey</td>
                                        <td hidden="hidden">@item.OrdKey</td>
                                        <td hidden="hidden">@item.ChlnKey</td>
                                        <td hidden="hidden">@item.InvKey</td>
                                        <td hidden="hidden">@item.PKSKey</td>
                                        <td hidden="hidden">@item.RateType</td>
                                        <td hidden="hidden">@item.RateCalcType</td>
                                        <td hidden="hidden">@item.DiscChargeAmt</td>
                                        <td hidden="hidden">@item.PendingFactor</td>
                                    </tr>
                                }
                            }
                        </tbody>
                    </table>
                }

            </div>
        </div>
        <div class="modal-footer" style="background-color:#cccccc;">
            <button type="button" class="btn btn-success" id="pickrecord">Accept Data</button>
            <button type="button" class="btn btn-danger" data-dismiss="modal">Discard</button>
        </div>
    </div>
</div>

<script src="@Url.Content("~/Content/js/jquery.constrain.js")" type="text/javascript"></script>
<script>
    $(document).ready(function () {


        if ($('#hdnVATGSTApp').val() == "V") {
            $('#igstvatrpostlbl').html('Tax Rate');
            $('#sgstvatrpostlbl').html('Surcharge Rate');
            $('#cgstvatrpostlbl').html('Addl.Tax Rate');
            $('#igstvatapostlbl').html('Tax Amt');
            $('#cgstvatapostlbl').html('Addl Tax Amt');
            $('#sgstvatapostlbl').html('Surcharge Amt');
        }

        if ($('#hdnMileStoneReqd').val() == "True") {
            $('#tabledatapick tbody tr').dblclick(function () {
                var tds = $(this).find('td');
                var ParentKey = tds.eq(9).text();
                $('#tabledatapick tbody tr').each(function () {
                    var tds2 = $(this).find('td');
                    var av = tds2.eq(9).text();
                    if (ParentKey.includes(av)) {
                        tds2.find('input[type="checkbox"]').prop("checked", true);
                    }
                })

            })
        }
        else {
            $('#tabledatapick tbody tr').dblclick(function () {
                var tds = $(this).find('td');
                var ParentKey = tds.eq(3).text();
                $('#tabledatapick tbody tr').each(function () {
                    var tds2 = $(this).find('td');
                    var av = tds2.eq(3).text();
                    if (ParentKey.includes(av)) {
                        tds2.find('input[type="checkbox"]').prop("checked", true);
                    }
                })

            })
        }

        $("#pickrecord").click(function (event) {
            event.preventDefault();
            var myTableArray = [];
            var acheckmil = 0;
            if ($('#hdnMileStoneReqd').val() == "True") {

                $('#tabledatapick tr:not(:first)').each(function () {
                    var tds = $(this).find('td');
                    if (tds.find('input[type="radio"]').is(':checked')) {
                        acheckmil = parseInt(acheckmil) + parseInt(1);
                    }
                })
                if (parseInt(acheckmil) == parseInt(0)) {
                    alert('Select a Ledger to Pickup')
                    return;
                }

                $('#tabledatapick tr:not(:first)').each(function () {
                    var tds = $(this).find('td');
                    if (tds.find('input[type="radio"]').is(':checked')) {
                        var myDets = {
                            tempId: tds.eq(1).text(),
                            Stage: tds.eq(4).text(),
                            MSTPer: tds.eq(5).text(),
                            PayStage: tds.eq(6).text(),
                            PayPercent: tds.eq(7).text(),
                            TableKey: tds.eq(8).text(),
                            ParentKey: tds.eq(9).text()
                        }
                        myTableArray.push(myDets);
                    }
                })
                var ModelData = {};
                ModelData["PickUpList"] = myTableArray;
                ModelData["SubType"] = $("#hdnSType").val();
                ModelData["MainType"] = $("#hdnMType").val();
                ModelData["SourceDoc"] = $("#RefDoc").val();
                ModelData["Type"] = $("#hdnType").val();
                ModelData["ChangeLog"] = $('#hdnchangelog').val();
                ModelData["MileStoneReqd"] = $('#hdnMileStoneReqd').val();
                var DTO = { Model: ModelData };
                var url = '@Url.Action("PostPickUp")';
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    data: JSON.stringify(DTO),
                    cache: false,
                    url: url,
                    contentType: "application/json;charset=utf-8",
                    beforesend: function () {
                        $('.spinner').show();
                    },
                    success: function (data) {
                        if (data.Status == "Success") {
                            $('.spinner').hide();
                            $('#ErrorMessage').hide();
                            $('#pickuplist').modal('hide');
                            if ($('#hdnchangelog').val() == "Add") {
                                $('#ItemChargeMoreDiv').html(data.Html);
                                if ($("#hdnSType").val() != "PI") {
                                    $("#BillNumber").val(data.BillNumber);
                                    $('#OrdDate').val(data.OrdDate);
                                }
                                if ($('#hdnCurrConv').val() == "Y") {
                                    $('#CurrName').val(data.CurrName).attr("selected", "selected");
                                    $('#CurrRate').val(data.CurrRate).attr("selected", "selected");
                                }
                            }
                            if ($('#hdnchangelog').val() == "Edit") {
                                $('#ItemListTable').html(data.Html);
                            }
                            $('#txtf_F001').val(data.Taxable.toFixed(2));
                            $('#txtb_F001').val(data.Taxable.toFixed(2));
                            $('#txttottxable').val(data.Taxable.toFixed(2));
                            $('#txttotcgst').val(data.CGSTAmt.toFixed(2));
                            $('#txttotsgst').val(data.SGSTAmt.toFixed(2));
                            $('#txttotigst').val(data.IGSTAmt.toFixed(2));
                            $('#txtMLSPercent').val(parseFloat(data.MLSPercent).toFixed(2))
                            if ($('#hdnSType').val() == "RP") {
                                $('#TDSAble').val(data.Taxable.toFixed(2));
                            }
                            SetValuesInTable()
                            $('#divLedgerTable :input').prop('disabled', true);
                            $('#CrPeriod').prop('disabled', false);
                            //$('#CurrDiv :input').prop('disabled', true);
                            if ($('#hdnSType').val() == "RP") {
                                loadValuesTdsAble()
                            }
                            document.getElementById("Sales").click();
                        }
                        else if (data.Status == "Fail") {
                            alert(data.Message)
                        }

                    },
                    error: function (err) {
                        alert(JSON.stringify(err))
                        $('.spinner').hide();
                        alert("error occured while processing your request.");
                    }
                });
            }
            else {

                $('#tabledatapick tr:not(:first)').each(function () {
                    var tds = $(this).find('td');
                    if (tds.find('input[type="checkbox"]').is(':checked')) {
                        acheckmil = parseInt(acheckmil) + parseInt(1);
                    }
                })
                if (parseInt(acheckmil) == parseInt(0)) {
                    alert('Select a Ledger to Pickup')
                    return;
                }
                if ($("#RefDoc").val() == "Blanket Order") {
                    if (parseInt(acheckmil) > parseInt(1)) {
                        alert('Select only one Ledger to Pickup')
                        return;
                    }
                }


                $('#tabledatapick tr:not(:first)').each(function () {
                    var tds = $(this).find('td');
                    if (tds.find('input[type="checkbox"]').is(':checked')) {
                        var myDets = {
                            tempId: tds.eq(1).text(),
                            TableKey: tds.eq(2).text(),
                            ParentKey: tds.eq(3).text(),
                            Code: tds.eq(5).text(),
                            ItemName: tds.eq(6).text(),
                            Store: tds.eq(7).text(),
                            Unit: tds.eq(8).text(),
                            HSN: tds.eq(9).text(),
                            GSTCode: tds.eq(10).text(),
                            Qty: tds.eq(11).text(),
                            Factor: tds.eq(12).text(),
                            Qty2: tds.eq(13).text(),
                            Unit2: tds.eq(14).text(),
                            RateOn2: tds.eq(15).text(),
                            Rate: tds.eq(16).text(),
                            Disc: tds.eq(17).text(),
                            DiscAmt: tds.eq(18).text(),
                            IGSTRate: tds.eq(19).text(),
                            CGSTRate: tds.eq(20).text(),
                            SGSTRate: tds.eq(21).text(),
                            IGSTAmt: tds.eq(22).text(),
                            CGSTAmt: tds.eq(23).text(),
                            SGSTAmt: tds.eq(24).text(),
                            Taxable: tds.eq(25).text(),
                            Val1: tds.eq(26).text(),
                            Narr: tds.eq(27).text(),
                            BinNumber: tds.eq(28).text(),
                            MainType: tds.eq(29).text(),
                            SubType: tds.eq(30).text(),
                            DiscPerAmt: tds.eq(31).text(),
                            IndKey: tds.eq(32).text(),
                            EnqKey: tds.eq(33).text(),
                            QtnKey: tds.eq(34).text(),
                            OrdKey: tds.eq(35).text(),
                            ChlnKey: tds.eq(36).text(),
                            InvKey: tds.eq(37).text(),
                            PKSKey: tds.eq(38).text(),
                            RateType: tds.eq(39).text(),
                            RateCalcType: tds.eq(40).text(),
                            DiscChargeAmt: tds.eq(41).text(),
                            PendingFactor: tds.eq(42).text(),
                        }
                        myTableArray.push(myDets);
                    }
                })
                var ModelData = {};
                ModelData["PickUpList"] = myTableArray;
                ModelData["SubType"] = $("#hdnSType").val();
                ModelData["MainType"] = $("#hdnMType").val();
                ModelData["SourceDoc"] = $("#RefDoc").val();
                ModelData["Type"] = $("#hdnType").val();
                ModelData["ChangeLog"] = $('#hdnchangelog').val();
                ModelData["LocationCode"] = $('#LocationCode').val();
                var DTO = { Model: ModelData };
                var url = '@Url.Action("PostPickUp")';
                $.ajax({
                    type: "POST",
                    dataType: "json",
                    data: JSON.stringify(DTO),
                    cache: false,
                    url: url,
                    contentType: "application/json;charset=utf-8",
                    beforesend: function () {
                        $('.spinner').show();
                    },
                    success: function (data) {
                        if (data.Status == "Success") {
                            $('.spinner').hide();
                            $('#ErrorMessage').hide();
                            $('#pickuplist').modal('hide');
                            if ($('#hdnchangelog').val() == "Add") {
                                $('#ItemChargeMoreDiv').html(data.Html);
                                if ($("#hdnSType").val() != "PI") {
                                    $("#BillNumber").val(data.BillNumber);
                                    $('#OrdDate').val(data.OrdDate);
                                }
                                if ($('#hdnCurrConv').val() == "Y") {
                                    $('#CurrName').val(data.CurrName).attr("selected", "selected");
                                    $('#CurrRate').val(data.CurrRate).attr("selected", "selected");
                                }
                            }
                            if ($('#hdnchangelog').val() == "Edit") {
                                $('#ItemListTable').html(data.Html);
                            }
                            $('#txtf_F001').val(data.Taxable.toFixed(2));
                            $('#txtb_F001').val(data.Taxable.toFixed(2));
                            $('#txttottxable').val(data.Taxable.toFixed(2));
                            $('#txttotcgst').val(data.CGSTAmt.toFixed(2));
                            $('#txttotsgst').val(data.SGSTAmt.toFixed(2));
                            $('#txttotigst').val(data.IGSTAmt.toFixed(2));
                            if ($('#hdnSType').val() == "RP") {
                                $('#TDSAble').val(data.Taxable.toFixed(2));
                            }
                            SetValuesInTable()
                            $('#divLedgerTable :input').prop('disabled', true);
                            $('#CrPeriod').prop('disabled', false);
                            //$('#CurrDiv :input').prop('disabled', true);
                            if ($('#hdnSType').val() == "RP") {
                                loadValuesTdsAble()
                            }
                            document.getElementById("Sales").click();
                        }
                        else if (data.Status == "Fail") {
                            alert(data.Message)
                        }
                    },
                    error: function (err) {
                        alert(JSON.stringify(err))
                        $('.spinner').hide();
                        alert("error occured while processing your request.");
                    }
                });
            }

        });
    });
</script>